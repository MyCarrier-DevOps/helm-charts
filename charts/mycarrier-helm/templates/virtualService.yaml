{{/* PERFORMANCE OPTIMIZATION: Precompute global context once instead of in every helper */}}
{{- $globalCtx := include "helm.context" $ | fromJson -}}
{{- range $appName, $appValues := .Values.applications }}
{{- $appContext := (merge (dict "appName" $appName "application" $appValues "ctx" $globalCtx) $) }}
{{- $domain := include "helm.domain" $ }}
{{- $domainPrefix := include "helm.domain.prefix" $ }}
{{- $namespace := include "helm.namespace" $ }}
{{- $fullName := include "helm.fullname" $appContext }}
{{- $metaenv := (include "helm.metaEnvironment" $ ) }}
{{- $istioConfig := dig "networking" "istio" dict $appValues }}
{{- $istioEnabled := true }}
{{- if and $istioConfig (hasKey $istioConfig "enabled") }}
{{- $istioEnabled = $istioConfig.enabled }}
{{- end }}
{{- $appIstioDisabled := dig "istioDisabled" false $appValues }}
{{- $serviceIstioDisabled := dig "service" "istioDisabled" false $appValues }}
{{- $renderVirtualService := and $istioEnabled (not $appIstioDisabled) (not $serviceIstioDisabled) }}
{{- if $renderVirtualService }}
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $fullName }}
  namespace: {{ $namespace }}
  labels:
    {{ include "helm.labels.standard" $appContext | indent 4 | trim }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true,Prune=true
    {{ include "helm.annotations.virtualservice" $ | indent 4 | trim }}
spec:
  {{ include "helm.specs.virtualservice" $appContext | indent 2 | trim }}
{{- if hasPrefix "feature" $.Values.environment.name }}
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $fullName }}-offload
  namespace: {{ $namespace }}
  labels:
    {{ include "helm.labels.standard" $appContext | indent 4 | trim }}
  annotations:
    {{ include "helm.annotations.virtualservice" $ | indent 4 | trim }}
spec:
  {{- $baseFullName := include "helm.basename" $appContext }}
  {{- $metaNamespace := include "helm.metaEnvironment" $ }}
  exportTo:
  - .
  - {{ $metaNamespace }}
  - istio-system
  hosts:
  - {{ $fullName }}
  - {{ $fullName }}.{{ $namespace }}.svc
  - {{ $fullName }}.{{ $namespace }}.svc.cluster.local
  - {{ $baseFullName }}
  - {{ $baseFullName }}.{{ $metaNamespace }}.internal
  - {{ $baseFullName }}.{{ $metaNamespace }}.svc
  - {{ $baseFullName }}.{{ $metaNamespace }}.svc.cluster.local
  {{ if (not $appValues.staticHostname)}}- {{ (list ($.Values.global.appStack) ($appName)) | join "-" | lower | trunc 63 | trimSuffix "-" }}.{{ $domainPrefix }}.{{ $domain }}{{ end -}}
  {{- if $appValues.staticHostname }}- {{ $appValues.staticHostname | trimSuffix "."}}.{{ $domain }}{{- end }}
  gateways:
  - mesh
  - istio-system/default
  http:
  - name: {{ $fullName }}
    route:
      - destination:
          host: "{{ $fullName }}.{{ $namespace }}.svc.cluster.local"
          port:
            number: {{ default 8080 (dig "ports" "http" nil $appValues) }}
    match:
      - headers:
          environment:
            exact: {{ $.Values.environment.name }}
  - name: {{ $baseFullName }}-dev-fallback
    match:
      - withoutHeaders:
          environment: {}
      - headers:
          environment:
            exact: {{ $metaNamespace }}
    route:
      - destination:
          host: "{{ $baseFullName }}.{{ $metaNamespace }}.svc.cluster.local"
          port:
            number: {{ default 8080 (dig "ports" "http" nil $appValues) }}
    headers:
{{ include "helm.istioIngress.responseHeaders" $ | nindent 6 }}
{{- end }}
{{- end }}
{{- end }}