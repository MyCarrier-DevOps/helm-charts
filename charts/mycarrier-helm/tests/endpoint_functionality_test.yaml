suite: test endpoint functionality (simplified)
templates:
  - virtualService.yaml
tests:
  - it: should support new kind/match format for exact matches
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "exact"
                  match: "/api/users"
                - kind: "exact" 
                  match: "/health"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      # Test that endpoints exist with correct URI matching
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/api/users"
            name: app-testapp-allowed--api-users
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/health"
            name: app-testapp-allowed--health
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should support new kind/match format for prefix matches
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "prefix"
                  match: "/api/"
                - kind: "prefix"
                  match: "/docs/"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: "/api/"
            name: app-testapp-allowed--api
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: "/docs/"
            name: app-testapp-allowed--docs
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should support new kind/match format for regex matches
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "regex"
                  match: "/webhook/(dwolla|plaid|stripe)"
                - kind: "regex"
                  match: "/api/v[12]/users"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  regex: "/webhook/(dwolla|plaid|stripe)"
            name: app-testapp-allowed--webhook-dwolla-plaid-stripe
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  regex: "/api/v[12]/users"
            name: app-testapp-allowed--api-v[12]-users
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should support mixed formats (new and legacy)
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - "/legacy/exact"
                - "/legacy/prefix/*"
                - kind: "exact"
                  match: "/new/exact"
                - kind: "prefix"
                  match: "/new/prefix/"
                - kind: "regex"
                  match: "/new/regex/[0-9]+"
    asserts:
      - hasDocuments:
          count: 1
      # Legacy format tests
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/legacy/exact"
            name: app-testapp-allowed--legacy-exact
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: "/legacy/prefix/"
            name: app-testapp-allowed--legacy-prefix-wildcard
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      # New format tests
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/new/exact"
            name: app-testapp-allowed--new-exact
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: "/new/prefix/"
            name: app-testapp-allowed--new-prefix
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  regex: "/new/regex/[0-9]+"
            name: app-testapp-allowed--new-regex-[0-9]
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should default to exact match for unrecognized kind
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "unknown"
                  match: "/api/test"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/api/test"
            name: app-testapp-allowed--api-test
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should preserve forbidden rule when using new format
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "exact"
                  match: "/allowed"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.http
          content:
            fault:
              abort:
                httpStatus: 403
                percentage:
                  value: 100
            match:
              - uri:
                  prefix: /
            name: app-testapp-forbidden

  # Test merged endpoints for C# language
  - it: should merge language-specific endpoints with user-defined endpoints for csharp
    set:
      global:
        language: "csharp"
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "exact"
                  match: "/custom/endpoint"
                - kind: "regex"
                  match: "/webhook/(stripe|paypal)"
    asserts:
      - hasDocuments:
          count: 1
      # Language-specific endpoints for C#
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/liveness"
            name: app-testapp-allowed--liveness
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/health"
            name: app-testapp-allowed--health
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: "/api"
            name: app-testapp-allowed--api
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      # User-defined endpoints
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/custom/endpoint"
            name: app-testapp-allowed--custom-endpoint
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  regex: "/webhook/(stripe|paypal)"
            name: app-testapp-allowed--webhook-stripe-paypal
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should only include user-defined endpoints for non-csharp languages
    set:
      global:
        language: "nodejs"
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "exact"
                  match: "/api/users"
                - kind: "prefix"
                  match: "/docs/"
    asserts:
      - hasDocuments:
          count: 1
      # Only user-defined endpoints should be present
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/api/users"
            name: app-testapp-allowed--api-users
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: "/docs/"
            name: app-testapp-allowed--docs
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      # Should NOT contain C# language-specific endpoints
      - notContains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/liveness"
            name: app-testapp-allowed--liveness
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - notContains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/health"
            name: app-testapp-allowed--health
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should include only language-specific endpoints for csharp without user-defined endpoints
    set:
      global:
        language: "csharp"
      applications:
        testapp:
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      # Language-specific endpoints for C#
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/liveness"
            name: app-testapp-allowed--liveness
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: "/health"
            name: app-testapp-allowed--health
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: "/api"
            name: app-testapp-allowed--api
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
