suite: Frontend VirtualService template tests
templates:
  - frontendVirtualService.yaml
tests:
  - it: should not create frontend virtualservice with single frontend app
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        frontend-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "frontend-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create frontend virtualservice without primary app
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        frontend-app1:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "frontend-app1"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        frontend-app2:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "frontend-app2"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should create frontend virtualservice when conditions are met
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.name
          value: test-stack-main-app-multifrontend
      - contains:
          path: spec.hosts
          content: test-stack-main-app.dev.internal

  - it: should omit internal host for feature frontend environments
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "feature-abc"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 2
      - notMatchRegex:
          path: spec.hosts[0]
          pattern: internal
        documentIndex: 0
      - equal:
          path: spec.hosts[0]
          value: test-stack-main-app-feature-abc
        documentIndex: 0
      - equal:
          path: spec.hosts[1]
          value: test-stack-main-app-feature-abc.dev.mycarrier.dev
        documentIndex: 0
      - equal:
          path: spec.hosts[0]
          value: test-stack-main-app-feature-abc
        documentIndex: 1
      - equal:
          path: spec.hosts[1]
          value: test-stack-main-app-feature-abc.feature-abc.svc
        documentIndex: 1
      - equal:
          path: spec.hosts[2]
          value: test-stack-main-app-feature-abc.feature-abc.svc.cluster.local
        documentIndex: 1
      - equal:
          path: spec.hosts[3]
          value: test-stack-main-app
        documentIndex: 1
      - equal:
          path: spec.hosts[4]
          value: test-stack-main-app.dev.internal
        documentIndex: 1
      - equal:
          path: spec.hosts[5]
          value: test-stack-main-app.dev.svc
        documentIndex: 1
      - equal:
          path: spec.hosts[6]
          value: test-stack-main-app.dev.svc.cluster.local
        documentIndex: 1
      - equal:
          path: spec.hosts[7]
          value: test-stack-frontend.dev.mycarrier.dev
        documentIndex: 1
      - equal:
          path: spec.http[0].match[0].headers.environment.exact
          value: feature-abc
        documentIndex: 1
      - equal:
          path: spec.http[1].match[0].withoutHeaders.environment
          value: {}
        documentIndex: 1
      - equal:
          path: spec.http[1].match[1].headers.environment.exact
          value: dev
        documentIndex: 1
      - equal:
          path: spec.http[1].route[0].destination.host
          value: test-stack-main-app.dev.svc.cluster.local
        documentIndex: 1
      - notExists:
          path: spec.http[1].headers.request
        documentIndex: 1
      - equal:
          path: spec.http[1].headers.response.set["Strict-Transport-Security"]
          value: "max-age=7884000; includeSubDomains; preload"
        documentIndex: 1

  - it: should set cloudflare-proxied to true by default on frontend virtualservice
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.annotations["external-dns.alpha.kubernetes.io/cloudflare-proxied"]
          value: "true"

  - it: should use primary apps cloudflareProxied setting for frontend virtualservice
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
              cloudflareProxied: false
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
              cloudflareProxied: true
    asserts:
      - hasDocuments:
          count: 1
      # Uses primary app (main-app) setting which is false
      - equal:
          path: metadata.annotations["external-dns.alpha.kubernetes.io/cloudflare-proxied"]
          value: "false"

  - it: should route custom routes to owning app service by default
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
              routes:
                welcome-portal:
                  match:
                    - uri:
                        prefix: /ui/welcome
                customer-portal:
                  match:
                    - uri:
                        prefix: /ui/customer
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      # Map iteration is alphabetical: customer-portal before welcome-portal
      - equal:
          path: spec.http[2].name
          value: customer-portal-custom-route
      - equal:
          path: spec.http[2].route[0].destination.host
          value: "test-stack-main-app.dev.svc.cluster.local"
      - equal:
          path: spec.http[2].route[0].destination.port.number
          value: 80
      - equal:
          path: spec.http[3].name
          value: welcome-portal-custom-route
      - equal:
          path: spec.http[3].route[0].destination.host
          value: "test-stack-main-app.dev.svc.cluster.local"

  - it: should use explicit destination override when specified in route
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
              routes:
                api-proxy:
                  destination: "backend-api.other-ns.svc.cluster.local"
                  match:
                    - uri:
                        prefix: /api/proxy
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.http[2].name
          value: api-proxy-custom-route
      - equal:
          path: spec.http[2].route[0].destination.host
          value: "backend-api.other-ns.svc.cluster.local"
      - equal:
          path: spec.http[2].route[0].destination.port.number
          value: 80
      # Ensure destination field is not rendered in the Istio route spec
      - notExists:
          path: spec.http[2].destination

  - it: should not include destination field in rendered route spec
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
              routes:
                my-route:
                  destination: "custom-svc.ns.svc.cluster.local"
                  match:
                    - uri:
                        prefix: /ui/portal
                  rewrite:
                    uri: /index.html
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.http[2].route[0].destination.host
          value: "custom-svc.ns.svc.cluster.local"
      # rewrite should still be present
      - equal:
          path: spec.http[2].rewrite.uri
          value: /index.html
      # destination should NOT leak as a top-level field on the http route
      - notExists:
          path: spec.http[2].destination