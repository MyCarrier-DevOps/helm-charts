suite: Frontend VirtualService template tests
templates:
  - frontendVirtualService.yaml
tests:
  - it: should not create frontend virtualservice with single frontend app
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        frontend-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "frontend-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create frontend virtualservice without primary app
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        frontend-app1:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "frontend-app1"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        frontend-app2:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "frontend-app2"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should create frontend virtualservice when conditions are met
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.name
          value: test-stack-main-app-multifrontend

  - it: should contain catchall route for primary application
    set:
      global:
        appStack: "frontend-domains"
      environment:
        name: "dev"
      applications:
        frontend:
          isFrontend: true
          isPrimary: true
          image:
            registry: "mycarrieracr.azurecr.io"
            repository: "src/itm/mycarrier/frontend"
            tag: "25.37.c1df573"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
              corsPolicy:
                allowOrigins:
                - exact: '*'
        admin-portal:
          isFrontend: true
          isPrimary: false
          routePrefix: /ui/admin
          image:
            registry: "mycarrieracr.azurecr.io"
            repository: "src/ui-domains/apps/admin-portal"
            tag: "25.37.c1df573"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      - contains:
          path: spec.http
          content:
            name: frontend-domains-frontend-catchall
            route:
            - destination:
                host: frontend-domains-frontend
                port:
                  number: 80
            match:
            - uri:
                exact: /