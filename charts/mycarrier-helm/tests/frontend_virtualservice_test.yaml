suite: Frontend VirtualService template tests
templates:
  - frontendVirtualService.yaml
tests:
  - it: should not create frontend virtualservice with single frontend app
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        frontend-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "frontend-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create frontend virtualservice without primary app
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        frontend-app1:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "frontend-app1"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        frontend-app2:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "frontend-app2"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should create frontend virtualservice when conditions are met
    set:
      global:
        appStack: "test-stack"
      environment:
        name: "dev"
      applications:
        main-app:
          isFrontend: true
          isPrimary: true
          image:
            registry: "registry.example.com"
            repository: "main-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
        admin-app:
          isFrontend: true
          isPrimary: false
          image:
            registry: "registry.example.com"
            repository: "admin-app"
            tag: "1.0.0"
          ports:
            http: 4200
          networking:
            istio:
              enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.name
          value: test-stack-main-app-multifrontend
      - contains:
          path: spec.hosts
          content: test-stack-main-app.dev.internal