suite: test allowed endpoints with new format
templates:
  - virtualService.yaml
tests:
  - it: should support mixed formats (new and legacy)
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - "/legacy/exact"
                - "/legacy/prefix/*"
                - kind: "exact"
                  match: "/new/exact"
                - kind: "prefix"
                  match: "/new/prefix/"
                - kind: "regex"
                  match: "/new/regex/[0-9]+"
    asserts:
      - hasDocuments:
          count: 1
      # Legacy format tests - need complete objects
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: /legacy/exact
            name: app-testapp-allowed--legacy-exact
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: /legacy/prefix/
            name: app-testapp-allowed--legacy-prefix-wildcard
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      # New format tests - need complete objects
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: /new/exact
            name: app-testapp-allowed--new-exact
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  prefix: /new/prefix/
            name: app-testapp-allowed--new-prefix
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  regex: /new/regex/[0-9]+
            name: app-testapp-allowed--new-regex-[0-9]
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should default to exact match for unrecognized kind
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "unknown"
                  match: "/api/test"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  exact: /api/test
            name: app-testapp-allowed--api-test
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s

  - it: should sanitize complex regex patterns in rule names
    set:
      applications:
        testapp:
          networking:
            istio:
              enabled: true
              allowedEndpoints:
                - kind: "regex"
                  match: "^/api/(users|orders)/(\\d+)/?$"
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: spec.http
          content:
            headers:
              response:
                set:
                  Content-Security-Policy: 'default-src https: ''unsafe-eval'' ''unsafe-inline'' blob: data: wss:; object-src ''none''; img-src http://*.osm.org https: data: blob:;'
                  Referrer-Policy: origin-when-cross-origin
                  Strict-Transport-Security: max-age=7884000; includeSubDomains; preload
                  X-Content-Type-Options: nosniff
                  X-Frame-Options: DENY
                  X-XSS-Protection: 1; mode=block
            match:
              - uri:
                  regex: ^/api/(users|orders)/(\d+)/?$
            name: app-testapp-allowed--api-users-orders-\d--
            retries:
              attempts: 3
              perTryTimeout: 50s
              retryOn: 5xx,reset
            route:
              - destination:
                  host: app-testapp
                  port:
                    number: 8080
                weight: 100
            timeout: 151s
