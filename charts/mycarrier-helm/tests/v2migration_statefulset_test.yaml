suite: V2 Migration Feature Tests - StatefulSets
templates:
  - statefulset.yaml
tests:
  - it: should use default sync options for statefulset when v2migration is false
    set:
      global:
        appStack: "test"
        language: "nodejs"
        v2migration: false
      environment:
        name: "dev"
      applications:
        test-statefulset:
          deploymentType: statefulset
          image:
            registry: "registry.example.com"
            repository: "test-statefulset"
            tag: "1.0.0"
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          value: "SkipDryRunOnMissingResource=true,Prune=true"
      - notMatchRegex:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          pattern: "Replace=true"
      - notMatchRegex:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          pattern: "Force=true"

  - it: should use v2migration sync options for statefulset when v2migration is true
    set:
      global:
        appStack: "test"
        language: "nodejs"
        v2migration: true
      environment:
        name: "dev"
      applications:
        test-statefulset:
          deploymentType: statefulset
          image:
            registry: "registry.example.com"
            repository: "test-statefulset"
            tag: "1.0.0"
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          value: "SkipDryRunOnMissingResource=true,Replace=true,Force=true"
      - matchRegex:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          pattern: "SkipDryRunOnMissingResource=true"
      - matchRegex:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          pattern: "Replace=true"
      - matchRegex:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          pattern: "Force=true"

  - it: should default to false for statefulset when v2migration is not set
    set:
      global:
        appStack: "test"
        language: "nodejs"
        # v2migration not explicitly set - should default to false
      environment:
        name: "dev"
      applications:
        test-statefulset:
          deploymentType: statefulset
          image:
            registry: "registry.example.com"
            repository: "test-statefulset"
            tag: "1.0.0"
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          value: "SkipDryRunOnMissingResource=true,Prune=true"

  - it: should preserve other annotations for statefulset when v2migration is enabled
    set:
      global:
        appStack: "test"
        language: "nodejs"
        v2migration: true
      environment:
        name: "dev"
      applications:
        test-statefulset:
          deploymentType: statefulset
          image:
            registry: "registry.example.com"
            repository: "test-statefulset"
            tag: "1.0.0"
    asserts:
      - isKind:
          of: StatefulSet
      - exists:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "10"
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-options"]
          value: "SkipDryRunOnMissingResource=true,Replace=true,Force=true"