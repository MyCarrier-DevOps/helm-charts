suite: deployment test
templates:
  - deployment.yaml
  - secret.yaml
tests:
  - it: should create deployment with correct name
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-mongobetween

  - it: should set correct replicas when autoscaling is disabled
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      autoscaling.enabled: false
      replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should not set replicas when autoscaling is enabled
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      autoscaling.enabled: true
    asserts:
      - notExists:
          path: spec.replicas

  - it: should include pool tuning parameters in MongoDB URI
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      poolTuning:
        minPoolSize: 50
        maxPoolSize: 500
        maxConnecting: 8
    asserts:
      - isKind:
          of: Deployment

  - it: should set resource requests and limits
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      resources:
        requests:
          cpu: "1"
          memory: "512Mi"
        limits:
          cpu: "2"
          memory: "1Gi"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "1"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "512Mi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "2"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "1Gi"

  - it: should set health probes when enabled
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      health.enabled: true
      health.port: 8080
    asserts:
      - exists:
          path: spec.template.spec.containers[0].livenessProbe
      - exists:
          path: spec.template.spec.containers[0].readinessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: health

  - it: should include REDIS_URL when dragonfly is enabled
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      dragonfly.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: REDIS_URL
          any: true

  - it: should use existing secret for MongoDB URI
    template: deployment.yaml
    set:
      mongodb.existingSecret: "my-secret"
      mongodb.existingSecretKey: "mongo-uri"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: "my-secret"
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.key
          value: "mongo-uri"

  - it: should set topology spread constraints when enabled
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      topologySpreadConstraints.enabled: true
      topologySpreadConstraints.maxSkew: 1
      topologySpreadConstraints.topologyKey: "topology.kubernetes.io/zone"
    asserts:
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].maxSkew
          value: 1
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: "topology.kubernetes.io/zone"

  - it: should set security context
    template: deployment.yaml
    set:
      mongodb.uri: "mongodb://localhost:27017/test"
      securityContext:
        runAsUser: 1000
        runAsNonRoot: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
